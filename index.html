<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>六月音乐播放器 - 优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e91e63;
            --secondary-color: #9c27b0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --progress-color: #e91e63;
            --progress-bg: #444;
            --control-size: 50px;
            --mini-player-height: 70px;
            --bg-overlay: rgba(30, 30, 30, 0.85);
            --lyrics-text: #ffffff; /* 动态歌词文本颜色 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            padding-bottom: var(--mini-player-height);
        }

        /* 头部样式 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 26px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 30px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-btn {
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: scale(1.1);
        }

        .search-btn i {
            font-size: 18px;
            color: white;
        }

        /* 主内容区样式 */
        .main-content {
            padding: 20px;
            height: calc(100vh - 70px - var(--mini-player-height));
            overflow-y: auto;
            transition: opacity 0.3s ease;
        }

        .main-content.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .chart-cover {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .chart-info h2 {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .chart-info p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .song-list {
            list-style: none;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.3s;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .song-index {
            width: 40px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .song-details {
            flex: 1;
            overflow: hidden;
        }

        .song-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-duration {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 15px;
        }

        /* 迷你播放器样式 */
        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--mini-player-height);
            background: var(--card-bg);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 500;
            transition: transform 0.3s ease;
        }

        .mini-player.hidden {
            transform: translateY(100%);
        }

        .mini-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 15px;
            object-fit: cover;
        }

        .mini-song-info {
            flex: 1;
            overflow: hidden;
        }

        .mini-song-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-song-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            background: var(--primary-color);
            color: white;
        }

        /* 全屏播放器样式 */
        .full-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            z-index: 300;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .full-player.active {
            opacity: 1;
            pointer-events: all;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .player-title {
            text-align: center;
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
        }

        .player-song-name {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
            margin: 0 auto 5px;
        }

        .player-artist-name {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .player-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .album-cover {
            width: 300px;
            height: 300px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            margin: 20px 0 40px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--progress-bg);
            border-radius: 5px;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }

        .progress {
            height: 100%;
            background: var(--progress-color);
            border-radius: 5px;
            width: 0%;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            cursor: grab;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .player-main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .main-control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .main-control-btn:hover {
            transform: scale(1.1);
        }

        .main-control-btn.play-pause {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 30px;
        }

        /* 歌词页面样式 - 对标 Apple Music */
        .lyrics-page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(20px);
            z-index: 310;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .lyrics-page.active {
            opacity: 1;
            pointer-events: all;
        }

        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            -webkit-overflow-scrolling: touch;
        }

        .lyrics-line {
            padding: 15px 0;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.5s ease;
            width: 100%;
            line-height: 1.6;
            opacity: 0.8;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .lyrics-line.active {
            color: var(--lyrics-text);
            font-size: 26px;
            font-weight: bold;
            transform: scale(1.05);
            opacity: 1;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
        }

        /* 加载指示器 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 搜索结果样式 - 全屏 */
        .search-results {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: var(--mini-player-height);
            background: var(--bg-color);
            z-index: 600; /* 提高层级，确保显示 */
            display: none;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(20px);
        }

        .search-results.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .search-results-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .back-btn:hover {
            transform: scale(1.1);
        }

        .search-results-title {
            font-size: 18px;
            font-weight: bold;
        }

        .results-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }

        .result-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .result-title {
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 二级菜单样式 */
        .secondary-menu {
            position: fixed;
            bottom: calc(var(--mini-player-height) + 20px);
            right: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 250;
            width: 280px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .secondary-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .menu-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-title {
            font-size: 18px;
            font-weight: bold;
        }

        .menu-section {
            padding: 15px 0;
        }

        .section-title {
            padding: 5px 20px;
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-item i {
            width: 30px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .menu-item span {
            flex: 1;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .history-song {
            font-size: 15px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 搜索历史面板 */
        .search-history {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 0 0 15px 15px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            z-index: 99;
            display: none;
            transition: opacity 0.2s ease;
        }

        .search-history.active {
            display: block;
            opacity: 1;
        }

        .history-header {
            padding: 10px 15px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .clear-history {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
        }

        .search-history-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-history-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .album-cover {
                width: 250px;
                height: 250px;
            }

            .main-control-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .main-control-btn.play-pause {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }

            .secondary-menu {
                width: 250px;
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }

            .search-container {
                gap: 5px;
            }

            .search-input {
                padding: 10px 15px;
            }

            .chart-cover {
                width: 80px;
                height: 80px;
            }

            .album-cover {
                width: 200px;
                height: 200px;
            }

            .secondary-menu {
                width: 90%;
                left: 5%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-music"></i>
            <span>六月音乐</span>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="搜索歌曲、歌手..." id="search-input">
            <button class="search-btn" id="search-btn">
                <i class="fas fa-search"></i>
            </button>
            <div class="search-history" id="search-history">
                <div class="history-header">
                    <span>搜索历史</span>
                    <span class="clear-history" id="clear-history">清空</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content" id="main-content">
        <div class="chart-header">
            <img src="" alt="热歌榜封面" class="chart-cover" id="chart-cover">
            <div class="chart-info" id="chart-info">
                <h2>热歌榜</h2>
                <p>六月热歌榜：用户一周内收听所有线上歌曲官方TOP排行榜，每日更新。</p>
            </div>
        </div>
        <ul class="song-list" id="song-list"></ul>
    </div>

    <!-- 迷你播放器 -->
    <div class="mini-player" id="mini-player">
        <img src="" alt="专辑封面" class="mini-cover" id="mini-cover">
        <div class="mini-song-info">
            <div class="mini-song-title" id="mini-song-title">未播放</div>
            <div class="mini-song-artist" id="mini-song-artist">请选择歌曲</div>
        </div>
        <div class="player-controls">
            <button class="control-btn" id="menu-btn">
                <i class="fas fa-ellipsis-h"></i>
            </button>
            <button class="control-btn play-pause" id="mini-play-btn">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <!-- 二级菜单 -->
    <div class="secondary-menu" id="secondary-menu">
        <div class="menu-header">
            <div class="menu-title">播放控制</div>
        </div>
        <div class="menu-section">
            <div class="section-title">播放历史</div>
            <div class="history-list" id="history-list"></div>
        </div>
        <div class="menu-section">
            <div class="menu-item" id="about-btn">
                <i class="fas fa-info-circle"></i>
                <span>关于六月音乐</span>
            </div>
        </div>
    </div>

    <!-- 全屏播放器 -->
    <div class="full-player" id="full-player">
        <div class="player-header">
            <button class="control-btn" id="close-player-btn">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="player-title">
                <div class="player-song-name" id="full-song-name"></div>
                <div class="player-artist-name" id="full-artist-name"></div>
            </div>
            <button class="control-btn" id="download-btn">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <div class="player-content">
            <img src="" alt="专辑封面" class="album-cover" id="album-cover">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
            <div class="player-main-controls">
                <button class="main-control-btn" id="prev-btn">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="main-control-btn play-pause" id="play-btn">
                    <i class="fas fa-play"></i>
                </button>
                <button class="main-control-btn" id="next-btn">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="main-control-btn" id="lyrics-btn">
                    <i class="fas fa-microphone-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 歌词页面 -->
    <div class="lyrics-page" id="lyrics-page">
        <div class="player-header">
            <button class="control-btn" id="back-to-player-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="player-title">
                <div class="player-song-name" id="lyrics-song-name"></div>
                <div class="player-artist-name" id="lyrics-artist-name"></div>
            </div>
            <button class="control-btn" id="download-lyrics-btn">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <div class="lyrics-container" id="lyrics-container">
            <div class="lyrics-line">歌词加载中...</div>
        </div>
    </div>

    <!-- 全屏搜索结果页面 -->
    <div class="search-results" id="search-results">
        <div class="search-results-header">
            <button class="back-btn" id="search-back-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="search-results-title">搜索结果</div>
        </div>
        <div class="results-list" id="results-list"></div>
    </div>

    <!-- 音频播放器 -->
    <audio id="audio-player"></audio>

    <script>
        // DOM元素
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchHistory = document.getElementById('search-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        const searchResults = document.getElementById('search-results');
        const resultsList = document.getElementById('results-list');
        const searchBackBtn = document.getElementById('search-back-btn');
        const songList = document.getElementById('song-list');
        const chartCover = document.getElementById('chart-cover');
        const chartInfo = document.getElementById('chart-info');
        const mainContent = document.getElementById('main-content');

        // 播放器相关元素
        const miniPlayer = document.getElementById('mini-player');
        const miniCover = document.getElementById('mini-cover');
        const miniSongTitle = document.getElementById('mini-song-title');
        const miniSongArtist = document.getElementById('mini-song-artist');
        const miniPlayBtn = document.getElementById('mini-play-btn');
        const menuBtn = document.getElementById('menu-btn');

        // 二级菜单
        const secondaryMenu = document.getElementById('secondary-menu');
        const historyList = document.getElementById('history-list');
        const aboutBtn = document.getElementById('about-btn');

        // 全屏播放器
        const fullPlayer = document.getElementById('full-player');
        const closePlayerBtn = document.getElementById('close-player-btn');
        const albumCover = document.getElementById('album-cover');
        const fullSongName = document.getElementById('full-song-name');
        const fullArtistName = document.getElementById('full-artist-name');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const lyricsBtn = document.getElementById('lyrics-btn');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const downloadBtn = document.getElementById('download-btn');

        // 歌词页面
        const lyricsPage = document.getElementById('lyrics-page');
        const backToPlayerBtn = document.getElementById('back-to-player-btn');
        const lyricsSongName = document.getElementById('lyrics-song-name');
        const lyricsArtistName = document.getElementById('lyrics-artist-name');
        const lyricsContainer = document.getElementById('lyrics-container');
        const downloadLyricsBtn = document.getElementById('download-lyrics-btn');

        // 音频播放器
        const audioPlayer = document.getElementById('audio-player');

        // 全局变量
        let currentSongs = [];
        let hotSongs = [];
        let currentIndex = 0;
        let isPlaying = false;
        let lyricsData = [];
        let lyricsLines = [];
        let bgOverlayColor = 'rgba(30, 30, 30, 0.85)';
        let searchQuery = '';
        let isLyricsScrolling = true; // 控制歌词是否自动滚动
        let scrollTimeout; // 定时器

        // 初始化数据
        function initData() {
            const history = localStorage.getItem('searchHistory');
            if (history) {
                renderSearchHistory(JSON.parse(history));
            }

            const playHistory = localStorage.getItem('playHistory');
            if (playHistory) {
                renderPlayHistory(JSON.parse(playHistory));
            }
        }

        // 格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 加载热歌榜
        async function loadHotSongs() {
            try {
                const response = await fetch('https://node.api.xfabe.com/api/wangyi/musicChart?list=热歌榜');
                const data = await response.json();

                if (data.code === 200) {
                    chartCover.src = data.data.listImg;
                    chartInfo.innerHTML = `
                        <h2>${data.data.listName}</h2>
                        <p>${data.data.listDesc}</p>
                    `;
                    currentSongs = data.data.songs;
                    hotSongs = [...currentSongs];
                    renderSongList(currentSongs);
                }
            } catch (error) {
                console.error('加载热歌榜失败:', error);
            }
        }

        // 渲染歌曲列表
        function renderSongList(songs) {
            songList.innerHTML = '';
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'song-item';
                li.dataset.index = index;
                li.innerHTML = `
                    <div class="song-index">${index + 1}</div>
                    <div class="song-details">
                        <div class="song-title">${song.name}</div>
                        <div class="song-artist">${song.artistsname}</div>
                    </div>
                    <div class="song-duration">${formatTime(song.duration / 1000)}</div>
                `;
                songList.appendChild(li);
            });

            document.querySelectorAll('.song-item').forEach(item => {
                item.addEventListener('click', function() {
                    playSong(parseInt(this.dataset.index));
                });
            });
        }

        // 搜索歌曲
        async function searchSongs(query) {
            if (!query) {
                searchResults.classList.remove('active');
                mainContent.classList.remove('hidden');
                return;
            }

            saveSearchHistory(query);
            searchQuery = query;
            searchResults.classList.add('active');
            mainContent.classList.add('hidden');
            resultsList.innerHTML = '<div class="loading">搜索中... <i class="fas fa-spinner"></i></div>';

            try {
                const response = await fetch(`https://node.api.xfabe.com/api/wangyi/search?search=${encodeURIComponent(query)}&limit=30`);
                const data = await response.json();

                if (data.code === 200 && data.data.songs.length > 0) {
                    resultsList.innerHTML = '';
                    currentSongs = data.data.songs.map(song => ({
                        ...song,
                        picurl: song.picurl || '' // 确保 picurl 存在
                    }));
                    currentSongs.forEach((song, index) => {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.dataset.index = index;
                        item.innerHTML = `
                            <div class="result-title">${song.name}</div>
                            <div class="result-artist">${song.artistsname} - ${song.album}</div>
                        `;
                        resultsList.appendChild(item);
                    });

                    document.querySelectorAll('.result-item').forEach(item => {
                        item.addEventListener('click', function() {
                            playSong(parseInt(this.dataset.index));
                        });
                    });
                } else {
                    resultsList.innerHTML = '<div class="result-item">没有找到相关歌曲</div>';
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsList.innerHTML = '<div class="result-item">搜索失败，请稍后再试</div>';
            }
        }

        // 保存搜索历史
        function saveSearchHistory(query) {
            let history = localStorage.getItem('searchHistory');
            let historyItems = history ? JSON.parse(history) : [];

            if (!historyItems.includes(query)) {
                if (historyItems.length >= 10) historyItems.pop();
                historyItems.unshift(query);
                localStorage.setItem('searchHistory', JSON.stringify(historyItems));
                renderSearchHistory(historyItems);
            }
        }

        // 渲染搜索历史
        function renderSearchHistory(historyItems) {
            searchHistory.innerHTML = `
                <div class="history-header">
                    <span>搜索历史</span>
                    <span class="clear-history" id="clear-history">清空</span>
                </div>
            `;
            historyItems.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                historyItem.textContent = item;
                historyItem.addEventListener('click', function() {
                    searchInput.value = item;
                    searchSongs(item);
                    searchHistory.classList.remove('active');
                });
                searchHistory.appendChild(historyItem);
            });
            document.getElementById('clear-history').addEventListener('click', clearSearchHistory);
        }

        // 清空搜索历史
        function clearSearchHistory() {
            localStorage.removeItem('searchHistory');
            searchHistory.innerHTML = `
                <div class="history-header">
                    <span>搜索历史</span>
                    <span class="clear-history" id="clear-history">清空</span>
                </div>
            `;
            document.getElementById('clear-history').addEventListener('click', clearSearchHistory);
        }

        // 播放歌曲
        async function playSong(index) {
            if (index < 0 || index >= currentSongs.length) return;

            currentIndex = index;
            const song = currentSongs[index];

            savePlayHistory(song);

            // 更新迷你播放器
            miniCover.src = song.picurl || '';
            miniSongTitle.textContent = song.name;
            miniSongArtist.textContent = song.artistsname;

            // 更新全屏播放器
            albumCover.src = song.picurl || '';
            fullSongName.textContent = song.name;
            fullArtistName.textContent = song.artistsname;

            // 更新歌词页面
            lyricsSongName.textContent = song.name;
            lyricsArtistName.textContent = song.artistsname;

            // 设置背景主题色并调整歌词文本颜色
            if (song.picurl) {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = song.picurl;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = this.width;
                    canvas.height = this.height;
                    ctx.drawImage(this, 0, 0);
                    const pixelData = ctx.getImageData(0, 0, 1, 1).data;
                    bgOverlayColor = `rgba(${pixelData[0]}, ${pixelData[1]}, ${pixelData[2]}, 0.7)`;
                    document.documentElement.style.setProperty('--bg-overlay', bgOverlayColor);
                    // 根据背景亮度调整歌词文本颜色
                    const brightness = (pixelData[0] * 299 + pixelData[1] * 587 + pixelData[2] * 114) / 1000;
                    const textColor = brightness > 125 ? '#000000' : '#ffffff';
                    document.documentElement.style.setProperty('--lyrics-text', textColor);
                };
            }

            // 获取播放地址
            try {
                const infoUrl = `https://node.api.xfabe.com/api/wangyi/music?type=json&id=${song.id}`;
                const response = await fetch(infoUrl);
                const data = await response.json();

                if (data.code === 200 && data.data.url) {
                    song.url = data.data.url;
                    song.pay = data.data.pay || "免费音乐";
                    song.picurl = data.data.picurl || song.picurl; // 更新封面URL
                } else {
                    throw new Error('未获取到播放地址');
                }
            } catch (error) {
                console.error('获取播放地址失败:', error);
            }

            // 设置音频源
            if (song.url) {
                audioPlayer.src = song.url;
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    updatePlayButtons();
                }).catch(error => {
                    console.error('播放失败:', error);
                    alert('播放失败: ' + (song.pay === "付费音乐" ? '该歌曲为付费音乐，可能无法播放完整版' : '播放出错'));
                });

                miniPlayer.style.display = 'flex';
                totalTimeEl.textContent = formatTime(song.duration / 1000);
                loadLyrics(song.id);
            } else {
                alert('无法播放: 该歌曲为付费音乐或未获取到播放地址');
            }
        }

        // 保存播放历史
        function savePlayHistory(song) {
            let history = localStorage.getItem('playHistory');
            let historyItems = history ? JSON.parse(history) : [];

            const existingIndex = historyItems.findIndex(item => item.id === song.id);
            if (existingIndex !== -1) historyItems.splice(existingIndex, 1);

            if (historyItems.length >= 10) historyItems.pop();
            historyItems.unshift({
                id: song.id,
                name: song.name,
                artistsname: song.artistsname,
                picurl: song.picurl,
                duration: song.duration
            });

            localStorage.setItem('playHistory', JSON.stringify(historyItems));
            renderPlayHistory(historyItems);
        }

        // 渲染播放历史
        function renderPlayHistory(historyItems) {
            historyList.innerHTML = historyItems.length === 0
                ? '<div class="history-item" style="text-align: center; color: var(--text-secondary);">暂无播放历史</div>'
                : '';
            historyItems.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.id = item.id;
                historyItem.innerHTML = `
                    <div class="history-song">${item.name}</div>
                    <div class="history-artist">${item.artistsname}</div>
                `;
                historyItem.addEventListener('click', function() {
                    const song = {
                        id: item.id,
                        name: item.name,
                        artistsname: item.artistsname,
                        picurl: item.picurl,
                        duration: item.duration,
                        pay: "免费音乐"
                    };
                    currentSongs = [song];
                    playSong(0);
                    secondaryMenu.classList.remove('active');
                });
                historyList.appendChild(historyItem);
            });
        }

        // 加载歌词
        async function loadLyrics(songId) {
            lyricsContainer.innerHTML = '<div class="lyrics-line">歌词加载中...</div>';
            try {
                const response = await fetch(`https://node.api.xfabe.com/api/wangyi/lyrics?id=${songId}`);
                const data = await response.json();
                if (data.code === 200 && data.data.lyric) {
                    lyricsData = parseLyrics(data.data.lyric);
                    renderLyrics();
                } else {
                    throw new Error(data.msg || '获取歌词失败');
                }
            } catch (error) {
                console.error('加载歌词失败:', error);
                lyricsContainer.innerHTML = '<div class="lyrics-line">歌词加载失败</div>';
            }
        }

        // 解析歌词
        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            lines.forEach(line => {
                const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;
                let match;
                const times = [];
                while ((match = timeRegex.exec(line)) !== null) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3]);
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    times.push(time);
                }
                const text = line.replace(timeRegex, '').trim();
                if (text && times.length > 0) {
                    times.forEach(time => result.push({ time, text }));
                }
            });
            result.sort((a, b) => a.time - b.time);
            return result;
        }

        // 渲染歌词
        function renderLyrics() {
            lyricsContainer.innerHTML = '';
            lyricsLines = [];
            if (lyricsData.length === 0) {
                lyricsContainer.innerHTML = '<div class="lyrics-line">暂无歌词</div>';
                return;
            }
            lyricsData.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'lyrics-line';
                div.textContent = line.text;
                div.dataset.time = line.time;
                div.addEventListener('click', function() {
                    audioPlayer.currentTime = parseFloat(this.dataset.time);
                });
                lyricsContainer.appendChild(div);
                lyricsLines.push(div);
            });
        }

        // 更新歌词显示
        function updateLyrics(currentTime) {
            if (!isLyricsScrolling) return; // 用户滑动时不自动更新
            let activeLine = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= currentTime) activeLine = i;
                else break;
            }
            lyricsLines.forEach((line, index) => {
                line.classList.toggle('active', index === activeLine);
            });
            if (activeLine >= 0 && lyricsLines[activeLine]) {
                const line = lyricsLines[activeLine];
                const containerHeight = lyricsContainer.offsetHeight;
                const scrollPos = line.offsetTop - containerHeight / 2;
                lyricsContainer.scrollTo({ top: scrollPos, behavior: 'smooth' });
            }
        }

        // 更新播放按钮状态
        function updatePlayButtons() {
            const playIcon = isPlaying ? 'fa-pause' : 'fa-play';
            miniPlayBtn.innerHTML = `<i class="fas ${playIcon}"></i>`;
            playBtn.innerHTML = `<i class="fas ${playIcon}"></i>`;
        }

        // 切换播放状态
        function togglePlay() {
            if (isPlaying) audioPlayer.pause();
            else audioPlayer.play();
            isPlaying = !isPlaying;
            updatePlayButtons();
        }

        // 播放下一首
        function playNext() {
            let nextIndex = currentIndex + 1;
            if (nextIndex >= currentSongs.length) nextIndex = 0;
            playSong(nextIndex);
        }

        // 播放上一首
        function playPrev() {
            let prevIndex = currentIndex - 1;
            if (prevIndex < 0) prevIndex = currentSongs.length - 1;
            playSong(prevIndex);
        }

        // 下载歌曲
        function downloadSong() {
            const song = currentSongs[currentIndex];
            if (song && song.url) {
                const downloadLink = document.createElement('a');
                downloadLink.href = song.url;
                downloadLink.download = `${song.name} - ${song.artistsname}.mp3`;
                downloadLink.target = '_self'; // 防止在新页面打开
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } else {
                alert('无法下载: 未获取到歌曲下载地址');
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            searchBtn.addEventListener('click', () => {
                if (searchInput.value.trim()) searchSongs(searchInput.value.trim());
            });

            searchInput.addEventListener('focus', function() {
                const history = localStorage.getItem('searchHistory');
                if (history && JSON.parse(history).length > 0) searchHistory.classList.add('active');
            });

            searchInput.addEventListener('blur', () => {
                setTimeout(() => searchHistory.classList.remove('active'), 200);
            });

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim()) searchSongs(this.value.trim());
            });

            searchBackBtn.addEventListener('click', () => {
                searchResults.classList.remove('active');
                mainContent.classList.remove('hidden');
                currentSongs = [...hotSongs];
                renderSongList(currentSongs);
            });

            miniPlayBtn.addEventListener('click', togglePlay);
            playBtn.addEventListener('click', togglePlay);
            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);

            miniPlayer.addEventListener('click', (e) => {
                if (!e.target.closest('.player-controls')) {
                    fullPlayer.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            });

            closePlayerBtn.addEventListener('click', () => {
                fullPlayer.classList.remove('active');
                document.body.style.overflow = 'auto';
            });

            lyricsBtn.addEventListener('click', () => {
                lyricsPage.classList.add('active');
            });

            backToPlayerBtn.addEventListener('click', () => {
                lyricsPage.classList.remove('active');
            });

            downloadBtn.addEventListener('click', downloadSong);
            downloadLyricsBtn.addEventListener('click', downloadSong);

            const progressBar = document.querySelector('.progress-bar');
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = pos * audioPlayer.duration;
            });

            // 触摸支持
            progressBar.addEventListener('touchstart', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const pos = (e.touches[0].clientX - rect.left) / rect.width;
                audioPlayer.currentTime = pos * audioPlayer.duration;
            });

            progressBar.addEventListener('touchmove', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const pos = (e.touches[0].clientX - rect.left) / rect.width;
                audioPlayer.currentTime = pos * audioPlayer.duration;
            });

            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                secondaryMenu.classList.toggle('active');
            });

            aboutBtn.addEventListener('click', () => {
                window.location.href = 'guanyu.php';
            });

            document.addEventListener('click', (e) => {
                if (!secondaryMenu.contains(e.target) && e.target !== menuBtn) {
                    secondaryMenu.classList.remove('active');
                }
            });

            audioPlayer.addEventListener('timeupdate', () => {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progress.style.width = `${percent}%`;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                if (lyricsPage.classList.contains('active')) updateLyrics(audioPlayer.currentTime);
            });

            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                updatePlayButtons();
            });
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayButtons();
            });

            // 歌词页面滑动事件
            lyricsContainer.addEventListener('scroll', () => {
                isLyricsScrolling = false;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    isLyricsScrolling = true;
                }, 3000);
            });

            lyricsContainer.addEventListener('touchmove', () => {
                isLyricsScrolling = false;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    isLyricsScrolling = true;
                }, 3000);
            });
        }

        // 初始化应用
        function initApp() {
            initData();
            loadHotSongs();
            initEventListeners();
            miniPlayer.style.display = 'none';
            document.documentElement.style.setProperty('--bg-overlay', bgOverlayColor);
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
